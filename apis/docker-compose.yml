services:
  # ──────────────── Deno (Oak + Postgres) ────────────────
  user:
    build: ./services/user
    env_file: .env
    environment:
      PORT: 3001
      PG_HOST: ${PG_USER_HOST}
      PG_DB:   ${PG_USER_DB}
      PG_USER: ${PG_USER_USER}
      PG_PASSWORD: ${PG_USER_PASSWORD}
    depends_on: [pg_user]
    ports: ["3001:3001"]

  project:
    build: ./services/project
    env_file: .env
    environment:
      PORT: 3002
      PG_HOST: ${PG_PROJECT_HOST}
      PG_DB:   ${PG_PROJECT_DB}
      PG_USER: ${PG_PROJECT_USER}
      PG_PASSWORD: ${PG_PROJECT_PASSWORD}
    depends_on: [pg_project]
    ports: ["3002:3002"]

  # ──────────────── Django (+ Mongo + SQLite) ────────────────
  item:
    build: ./services/item
    env_file: .env
    environment:
      MONGO_URI: ${ITEM_MONGO_URI}
      MONGO_DB:  ${ITEM_MONGO_DB}
    depends_on: [mongo_item]
    ports: ["8001:8000"]

  analysis:
    build: ./services/analysis
    env_file: .env
    environment:
      MONGO_URI: ${ANALYSIS_MONGO_URI}
      MONGO_DB:  ${ANALYSIS_MONGO_DB}
    depends_on: [mongo_analysis]
    ports: ["8002:8000"]

  # ──────────────── Data Stores ────────────────
  pg_user:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${PG_USER_DB}
      POSTGRES_USER: ${PG_USER_USER}
      POSTGRES_PASSWORD: ${PG_USER_PASSWORD}
    volumes: [pg_user_data:/var/lib/postgresql/data]

  pg_project:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${PG_PROJECT_DB}
      POSTGRES_USER: ${PG_PROJECT_USER}
      POSTGRES_PASSWORD: ${PG_PROJECT_PASSWORD}
    volumes: [pg_project_data:/var/lib/postgresql/data]

  mongo_item:
    image: mongo:7-jammy
    environment:
      MONGO_INITDB_DATABASE: ${ITEM_MONGO_DB}
    volumes: [mongo_item_data:/data/db]

  mongo_analysis:
    image: mongo:7-jammy
    environment:
      MONGO_INITDB_DATABASE: ${ANALYSIS_MONGO_DB}
    volumes: [mongo_analysis_data:/data/db]

volumes:
  pg_user_data:
  pg_project_data:
  mongo_item_data:
  mongo_analysis_data: